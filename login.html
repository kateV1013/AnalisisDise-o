<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StudyFlow - Login</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <header>
        <h1>StudyFlow · Iniciar sesión</h1>
        <span>Planificador de tareas y notas</span>
    </header>

    <main>
        <section class="card">
            <h2>Accede a tu cuenta</h2>
            <p class="small">Usa el correo y la contraseña que registraste.</p>

            <form id="formLogin">
                <div class="form-row">
                    <div class="form-group">
                        <label for="loginEmail">Correo electrónico</label>
                        <input type="email" id="loginEmail" required autofocus />
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Contraseña</label>
                        <input type="password" id="loginPassword" required />
                    </div>
                </div>

                <div class="btn-row">
                    <button type="submit">Entrar</button>
                    <a class="btn-link" href="registro.html">Crear nueva cuenta</a>
                </div>
                <div id="msgLogin" class="msg" role="status" aria-live="polite"></div>
            </form>
        </section>
    </main>

    <script>
        // Utility: show message
        function showMsg(text, type) {
            const el = document.getElementById('msgLogin');
            el.textContent = text || '';
            el.className = 'msg' + (type === 'ok' ? ' msg-ok' : type === 'error' ? ' msg-error' : '');
        }

        // Load registered users from 'studyflowUsers' (array).
        // Backward-compatible fallback:
        // - if 'studyflowUsers' missing but older 'studyflowUser' exists and includes password, use it.
        function getRegisteredUsers() {
            try {
                const raw = localStorage.getItem('studyflowUsers');
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (Array.isArray(parsed)) return parsed;
                }
            } catch (e) {
                // ignore parse errors
            }

            // Fallback: single-user key (older versions)
            try {
                const singleRaw = localStorage.getItem('studyflowUser');
                if (singleRaw) {
                    const single = JSON.parse(singleRaw);
                    // Only accept fallback if password is present (registration used older single-key approach)
                    if (single && single.email && single.password) {
                        return [single];
                    }
                }
            } catch (e) {
                // ignore
            }

            return [];
        }

        // Save active profile (reduced) and mark logged in.
        function setActiveUserFromRegistered(regUser) {
            const profile = {
                nombre: regUser.nombre || regUser.name || '',
                apellido: regUser.apellido || '',
                email: regUser.email || '',
                institucion: regUser.institucion || '',
                tipoInstitucion: regUser.tipoInstitucion || ''
            };
            localStorage.setItem('studyflowUser', JSON.stringify(profile));
            localStorage.setItem('studyflowLoggedIn', 'true');
        }

        // On load: prefill email when possible
        document.addEventListener('DOMContentLoaded', () => {
            const last = localStorage.getItem('studyflowLastRegistered');
            if (last) {
                const input = document.getElementById('loginEmail');
                if (input) input.value = last;
                // optional: keep the hint for one-time use
                localStorage.removeItem('studyflowLastRegistered');
            } else {
                // if there is a single legacy studyflowUser with email, prefill (only if not an array-based registration)
                try {
                    const singleRaw = localStorage.getItem('studyflowUser');
                    if (singleRaw) {
                        const single = JSON.parse(singleRaw);
                        if (single && single.email) {
                            const input = document.getElementById('loginEmail');
                            if (input && !input.value) input.value = single.email;
                        }
                    }
                } catch (e) { /* ignore */ }
            }
        });

        // Form submit: validate against registered users array (or fallback)
        document.getElementById('formLogin').addEventListener('submit', function (e) {
            e.preventDefault();
            showMsg('', null);

            const email = (document.getElementById('loginEmail').value || '').trim().toLowerCase();
            const password = (document.getElementById('loginPassword').value || '').trim();

            if (!email || !password) {
                showMsg('Ingrese correo y contraseña.', 'error');
                return;
            }

            const users = getRegisteredUsers();
            if (!users.length) {
                showMsg('No hay usuarios registrados. Crea una cuenta primero.', 'error');
                return;
            }

            // Find user matching email and password (demo: plain-text check)
            const matched = users.find(u => (u.email || '').toLowerCase() === email && (u.password || '') === password);

            if (!matched) {
                showMsg('Correo o contraseña incorrectos.', 'error');
                return;
            }

            // Success: set active profile and redirect
            setActiveUserFromRegistered(matched);
            showMsg('Ingreso correcto. Redirigiendo…', 'ok');

            setTimeout(() => {
                window.location.href = 'studyflow.html';
            }, 700);
        });
    </script>
</body>
</html>